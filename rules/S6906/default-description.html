<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Java 21 virtual threads allow the JVM to optimize the usage of OS threads,
by mounting and unmounting them on an OS thread when needed, and
making them more efficient when dealing with blocking operations such as HTTP requests or I/O.</p>
</div>
<div class="paragraph">
<p>However, when code is executed inside a <code>synchronized</code> block or <code>synchronized</code> method,
the virtual thread stays pinned to the underlying OS thread and cannot be unmounted during a blocking operation.
This will cause the OS thread to be blocked, which can impact the scalability of the application.</p>
</div>
<div class="paragraph">
<p>Therefore, virtual threads should not execute code that contains <code>synchronized</code> blocks or invokes <code>synchronized</code> methods.
Platform threads should be used in these cases.</p>
</div>
<div class="paragraph">
<p>This rule raises an issue when a virtual thread contains <code>synchronized</code> blocks or invokes <code>synchronized</code> methods.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">void enqueue(){
    Thread.startVirtualThread(() -&gt; { // Noncompliant; use a platform thread instead
            setupOperations();
            dequeLogic();
        }
    });
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">void enqueue(){
    new Thread(() -&gt; {
        synchronized {
            setupOperations();
            dequeLogic();
        }
    }).start();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example_2">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">void enqueue2(){
    Thread.startVirtualThread(() -&gt; { // Noncompliant; use a platform thread instead of a virtual one
        if(someCondition){
            synchronizedMethod();
        }else{
            defaultLogic();
        }
    });
}
synchronized void synchronizedMethod(){}
void defaultLogic(){}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_2">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">void enqueue2(){
    new Thread(() -&gt; {
        if(someCondition){
            synchronizedMethod();
        }else{
            defaultLogic();
        }
    }).start();
}
synchronized void synchronizedMethod(){}
void defaultLogic(){}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Java Documentation - <a href="https://openjdk.org/jeps/444#:~:text=There%20are%20two,by%20capturing%20carriers">Virtual threads, pinning scenarios</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>